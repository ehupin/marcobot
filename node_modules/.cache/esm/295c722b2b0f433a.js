"main";let fs;_2b0‍.w("fs",[["default",["fs"],function(v){fs=v}]]);let connectDb,clearDatabase,createDbNode,connectDbNodes;_2b0‍.w("./database.js",[["connectDb",["connectDb"],function(v){connectDb=v}],["clearDatabase",["clearDatabase"],function(v){clearDatabase=v}],["createDbNode",["createDbNode"],function(v){createDbNode=v}],["connectDbNodes",["connectDbNodes"],function(v){connectDbNodes=v}]]);



async function setupDb(){
    const db = connectDb()
    await clearDatabase(db)
    
    const collectionsToCreate = [
            'markets',
            'currencies',
            'exchanges',
            ]
    for (let collection of collectionsToCreate){
        await db.collection(collection).create()
    }
    
    const edgeCollectionsToCreate = [
        'marketHasExchange',
        'marketHasBaseCurrency',
        'marketHasQuoteCurrency',
        'exchangeHasCurrency',
    ]
    
    for (let edgeCollection of edgeCollectionsToCreate){
        await db.edgeCollection(edgeCollection).create()
    }
    
    
    
    // exchanges dir is read to load js files
    fs.readdir('exchanges', async (err,moduleFiles)=>{
        
        // modules are loaded in a object
        let exchangeModules = {}
        for (const moduleFile of moduleFiles){
            const exchangeName = moduleFile.split('.')[0]
            exchangeModules[exchangeName] = require(`./exchanges/${moduleFile}`)[exchangeName]
            // break
            
        }
        
        // build objects to store nodes and edges
        let marketNodes = {}
        let currencyNodes = {}
        let exchangeNodes = {}
        let tempEdges = TempEdges()
        
        // build exchanges nodes
        for (let exchangeModuleName of Object.keys(exchangeModules)){
            const exchangeNodeData = {
                                        label: exchangeModuleName,
                                        tradingFees: exchangeModules[exchangeModuleName].tradingFees
                                    }
            exchangeNodes[exchangeModuleName] = await createDbNode(db, 'exchanges', exchangeNodeData)
        }
        
        // loop throught exchanges and markets to fill marketNodes and currencyNodes, also add edges to tempEdges object
        for (let exchangeModuleName of Object.keys(exchangeModules)){
            
            const markets = await exchangeModules[exchangeModuleName].fetchMarkets()
            for (let market of markets){
                
                const marketLabel = `${market.exchange} - ${market.baseCurrency}/${market.quoteCurrency}`
                
                if (!Object.keys(marketNodes).includes(marketLabel)){
                    marketNodes[marketLabel] = await createDbNode(db, 'markets', {label: marketLabel})
                }
                
                if (!Object.keys(currencyNodes).includes(market.baseCurrency)){
                    currencyNodes[market.baseCurrency] = await createDbNode(db, 'currencies', {label: market.baseCurrency})
                }
                
                if (!Object.keys(currencyNodes).includes(market.quoteCurrency)){
                    currencyNodes[market.quoteCurrency] = await createDbNode(db, 'currencies', {label: market.quoteCurrency})
                }
                
                // get node ids then generate links
                const marketNode = marketNodes[marketLabel]
                const exchangeNode = exchangeNodes[market.exchange]
                const baseCurrencyNode = currencyNodes[market.baseCurrency]
                const quoteCurrencyNode= currencyNodes[market.quoteCurrency]
                
                // console.log(marketNodes)
                // console.log(currencyNodes)
                // console.log(market.exchange)
                
                
                tempEdges.add('marketHasExchange', marketNode, exchangeNode)
                tempEdges.add('marketHasBaseCurrency', marketNode, baseCurrencyNode)
                tempEdges.add('marketHasQuoteCurrency', marketNode, quoteCurrencyNode)
                tempEdges.add('exchangeHasCurrency', 
                            exchangeNode, 
                            baseCurrencyNode, 
                            {
                                withdrawalFees: exchangeModules[market.exchange].withdrawalFees[market.baseCurrency]
                                
                            })
                tempEdges.add('exchangeHasCurrency', 
                            exchangeNode, 
                            quoteCurrencyNode, 
                            {
                                withdrawalFees: exchangeModules[market.exchange].withdrawalFees[market.quoteCurrency]
                                
                            })
                            
                // tempEdges.add('exchangeHasCurrency', exchangeNode, quoteCurrencyNode)
                
            }
            // tempEdgeTree.out()
           tempEdges.build(db)
            
        }
    })
}
function TempEdges(){
    let edgeTree = {}
    return {
        add(type, from, to, data){
            
            const toItem = [to._id, data]
            
            if (!Object.keys(edgeTree).includes(type)){
                edgeTree[type] = {}
            }
            if (!Object.keys(edgeTree[type]).includes(from._id)){
                edgeTree[type][from._id] = [toItem]
            }
            else {
                // console.log(2)
                edgeTree[type][from._id].push(toItem)
            }
            // console.log('\n==================\n',type, from,to, '\n',edgeTree,'\n\n')
        },
        out(){
          const json = JSON.stringify(edgeTree, null, 4)
          var fs = require('fs');
            fs.writeFile('myjsonfile.json', json, 'utf8', ()=>{});
        },
        build(db){
            for (let type of Object.keys(edgeTree)){
                for (let from of Object.keys(edgeTree[type])){
                    for (let toItem of edgeTree[type][from]){
                        // console.log('{{{{{{--',from,to)
                        const to = toItem[0]
                        const data = toItem[1]
                        connectDbNodes(db, type, from, to, data)
                    }
                }
            }
        }
    }
}




setupDb()
