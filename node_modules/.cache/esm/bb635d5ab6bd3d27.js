"main";let fs;_b6b‍.w("fs",[["default",["fs"],function(v){fs=v}]]);let connectDb,clearDatabase,createDbNode,connectDbNodes,getExchangeMarkets,setMarketPrice;_b6b‍.w("./database.js",[["connectDb",["connectDb"],function(v){connectDb=v}],["clearDatabase",["clearDatabase"],function(v){clearDatabase=v}],["createDbNode",["createDbNode"],function(v){createDbNode=v}],["connectDbNodes",["connectDbNodes"],function(v){connectDbNodes=v}],["getExchangeMarkets",["getExchangeMarkets"],function(v){getExchangeMarkets=v}],["setMarketPrice",["setMarketPrice"],function(v){setMarketPrice=v}]]);




async function updateDb(){
    const db = connectDb()
    
    // exchanges dir is read to load js files
    let exchangeModules = {}
    const exchangeModuleFiles = fs.readdirSync('exchanges')
    for (let exchangeModuleFile of exchangeModuleFiles){
        const exchangeName = exchangeModuleFile.split('.')[0]
        exchangeModules[exchangeName] = require(`./exchanges/${exchangeModuleFile}`)[exchangeName]
    }

    
    for (let exchangeName of Object.keys(exchangeModules)){
        const markets = await getExchangeMarkets(db, exchangeName)
        _b6b‍.g.console.log('==========================',exchangeName)
        for (let market of markets){
            market = await exchangeModules[exchangeName].fetchMarketPrice(market)
            if (market.price){
                // console.log(market)
                setMarketPrice(db, market)    
            }
            
        }
        
    }
    
    return
    
    
    
        
    // build objects to store nodes and edges
    let marketNodes = {}
    let currencyNodes = {}
    let exchangeNodes = {}
    let tempEdges = TempEdges()
    
    // build exchanges nodes
    for (let exchangeModuleName of Object.keys(exchangeModules)){
        const exchangeNodeData = {
                                    label: exchangeModuleName,
                                    tradingFees: exchangeModules[exchangeModuleName].tradingFees
                                }
        exchangeNodes[exchangeModuleName] = await createDbNode(db, 'exchanges', exchangeNodeData)
    }
    
    // loop throught exchanges and markets to fill marketNodes and currencyNodes, also add edges to tempEdges object
    for (let exchangeModuleName of Object.keys(exchangeModules)){
        const markets = await exchangeModules[exchangeModuleName].fetchMarkets()
        for (let market of markets){
            
            const marketLabel = `${market.exchange} - ${market.baseCurrency}/${market.quoteCurrency}`
            
            if (!Object.keys(marketNodes).includes(marketLabel)){
                marketNodes[marketLabel] = await createDbNode(db, 'markets', {label: marketLabel})
            }
            
            if (!Object.keys(currencyNodes).includes(market.baseCurrency)){
                currencyNodes[market.baseCurrency] = await createDbNode(db, 'currencies', {label: market.baseCurrency})
            }
            
            if (!Object.keys(currencyNodes).includes(market.quoteCurrency)){
                currencyNodes[market.quoteCurrency] = await createDbNode(db, 'currencies', {label: market.quoteCurrency})
            }
            
            // get node ids then generate links
            const marketNode = marketNodes[marketLabel]
            const exchangeNode = exchangeNodes[market.exchange]
            const baseCurrencyNode = currencyNodes[market.baseCurrency]
            const quoteCurrencyNode= currencyNodes[market.quoteCurrency]
            
            // console.log(marketNodes)
            // console.log(currencyNodes)
            // console.log(market.exchange)
            
            
            tempEdges.add('marketHasExchange', marketNode, exchangeNode)
            tempEdges.add('marketHasCurrency', marketNode, baseCurrencyNode, {type: 'base'})
            tempEdges.add('marketHasCurrency', marketNode, quoteCurrencyNode, {type: 'quote'})
            tempEdges.add('exchangeHasCurrency', 
                        exchangeNode, 
                        baseCurrencyNode, 
                        {
                            withdrawalFees: exchangeModules[market.exchange].withdrawalFees[market.baseCurrency]
                        })
            // tempEdges.add('exchangeHasCurrency', 
            //             exchangeNode, 
            //             quoteCurrencyNode, 
            //             {
            //                 withdrawalFees: exchangeModules[market.exchange].withdrawalFees[market.quoteCurrency]
                            
            //             })
                        
            // tempEdges.add('exchangeHasCurrency', exchangeNode, quoteCurrencyNode)
            
        }
        // tempEdgeTree.out()
       tempEdges.build(db)
        
    }
}



// updateDb()

var request = require('request');
var cheerio = require('cheerio');

request('https://exchangebit.info/bittrex', function(err, resp, html) {
        if (!err){
          const $ = cheerio.load(html);
          let n = 0
          $(`html body main.container table.table.table-striped.border.table-sm tr`).each((i,tr)=>{
            // if (n<1){
            //     console.log( $(tr).find('td').children())
            // }
                n += 1
            
            
            const tds = $(tr).find('td')
            // const coinLabel = tds.get(0).find('a').data()
            const withdrawFees = tds.get(2).data()
            
            _b6b‍.g.console.log( withdrawFees)
            
            if (n>1){return false}
            return
            
            // .each((id,td)=>{
            //     // if (id = 3){}
            //     // const withdrawalFees
            //     console.log(id, td.children[0].data)
                
            // })
          })
        //   console.log(typeof(main))
          
          
          
        //   $('tr').each(function(index, element){
            //   console.log(element.html())
              
            //   for (let child of element.children){
            //       cons
            //   }
            //   console.log(element)
            //   console.log('=========')
            //   let coin = $(element).find("a").text()
            //   $(element).each((i,e)=>{
            //       console.log(e)
                  
            //   })
              
            //   console.log(fees)
              
        //   })
      }
})


// For each .item, we add all the structure of a company to the companiesList array
// Don't try to understand what follows because we will do it differently.
// $('tr').each(function(index, element){
    // console.log(element)
// 	companiesList[index] = {};
// 	var header = $(element).find('.header');
// 	companiesList[index]['name'] = $(header).find('[itemprop=name]').text();
// 	companiesList[index]['description'] = $(header).find('[rel=description]').text();
// 	companiesList[index]['url'] = $(header).find('.header [itemprop=name] a').getAttribute('href');
// 	var contact = $(element).find('.contact');
// 	companiesList[index]['contact'] = {};
// 	companiesList[index]['contact']['telephone'] = $(contact).find('[itemprop=telephone]').text();
// 	companiesList[index]['contact']['employee'] = {};
// 	companiesList[index]['contact']['employee']['name'] = $(contact).find('[itemprop=employeeName]').text();
// 	companiesList[index]['contact']['employee']['jobTitle'] = $(contact).find('[itemprop=employeeJobTitle]').text();
// 	companiesList[index]['contact']['employee']['email'] = $(contact).find('[itemprop=email]').text();
// });

// console.log(companiesList); // Output the data in the terminal