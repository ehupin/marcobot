"main";_50e‍.x([["clearDatabase",()=>clearDatabase],["createDbNode",()=>createDbNode],["connectDbNodes",()=>connectDbNodes],["setMarketPrice",()=>setMarketPrice],["getExchangeMarkets",()=>getExchangeMarkets],["connectDb",()=>connectDb]]);let Database,aql;_50e‍.w("arangojs",[["Database",["Database"],function(v){Database=v}],["aql",["aql"],function(v){aql=v}]]);// import {getNodetypes} from '../common/utils.js'

// import {listPairs} from './pairs.js'
// import {exchanges_fees} from './exchanges.js'



       async function clearDatabase(db) {
    for (let collection of await db.listCollections()) {
        if (!collection.isSystem) {
            await db.collection(collection.name).drop();
        }
    }
}

async function createDatabase(db, dbName){
    // create zoa database
    const databases = await db.listDatabases()
    if (!databases.includes(dbName)){
        db.createDatabase(dbName)
    }
}

async function initDb(){
    const collections = await db.listCollections()
    const collectionsName = collections.map(collection => collection.name);
    
    for (let collectionName of ['exchange', 'currency', 'market']){
        if (!collectionsName.includes(collectionName)){
            let collection = db.collection(collectionName);
            // console.log(collection)
            collection.create()
        }
    }
    
    for (let collectionName of ['market_has_exchange','market_has_baseCurrency', 'market_has_quoteCurrency', 'exchange_has_currency']){
        if (!collectionsName.includes(collectionName)){
            let collection = db.edgeCollection(collectionName);
            // console.log(collection)
            collection.create()
        }
    }
    
    
    
    // db.edgeCollection(collectionName, true)
    
}
    
async function updateCollections(){
    const collections = await db.listCollections()
    const collectionsName = collections.map(collection => collection.name);
    
    // for each nodetype, create a collection if it doesn't exist
    getNodetypes().forEach(async function (nodetype) {
        
        if (!collectionsName.includes(nodetype.name)){
            let collection = db.collection(nodetype.name);
            // TODO: prevent creation of collectionns starting with "_", check it seems to be prevented by default
            await collection.create()
        }
    })
}

       async function createDbNode (db, nodetypeName, nodeData) {
    
    const cursor = await db.query(aql`
        INSERT 
        ${nodeData}
        INTO ${db.collection(nodetypeName)}
        RETURN NEW
    `);
    let node = await cursor.next()
    // node._nodetypeName = nodetypeName
    return node
}


       async function connectDbNodes (db, collectionName, sourceNodeId, destNodeId, data) {
    
    
    // UPSERT { mail: 'email@ndd.com' }
    // INSERT { }
    // UPDATE { mail: 'email@ndd.com', name: 'fab1', arrayinfo: [{stringheader:'value15258'}]}
    // IN tuto
    // RETURN { OLD: OLD, NEW: NEW }

    // console
    // console.log('\n=====================\n')
    // console.log('>>', destNode._id)
    
    let edgeDescription = {
        _from : sourceNodeId,
        _to: destNodeId
    }
    
    edgeDescription = Object.assign(edgeDescription, data)
    _50e‍.g.console.log('>>>>>>',edgeDescription)
    
    const cursor = await db.query(aql`INSERT ${edgeDescription} IN ${db.edgeCollection(collectionName)}`);
    // let node = cursor.next()
    // return node
}

       async function setMarketPrice(db, market, price){
    const cursor = await db.query(aql`
    UPDATE {label:" ${market.label}"} WITH {price: ${price}} IN markets
    `);
}

       async function getExchangeMarkets(db, exchangeName){
    const cursor = await db.query(aql`
    for exchange in exchanges filter exchange.label == ${exchangeName}
    for market in inbound exchange._id marketHasExchange
    return distinct market
    `);
    return cursor.all()
}

function buildDb(){
    initDb().then(()=>{
        listPairs().then(async (pairs) => {
            let exchanges = {}
            let currencies = {}
            let markets = []
            for(let pair of pairs){
                _50e‍.g.console.log('\n====================\n')
                if (!Object.keys(exchanges).includes(pair.exchange)){
                    exchanges[pair.exchange] = await createDbNode('exchange', {label: pair.exchange})
                }
                
                if (!Object.keys(currencies).includes(pair.baseCurrency)){
                    currencies[pair.baseCurrency] = await createDbNode('currency', {label: pair.baseCurrency})
                }
                
                if (!Object.keys(currencies).includes(pair.quoteCurrency)){
                    currencies[pair.quoteCurrency] = await createDbNode('currency', {label: pair.quoteCurrency})
                }
                

                const market = await createDbNode('market', {label: `${pair.baseCurrency}/${pair.quoteCurrency} - ${pair.exchange}`})
             
                connectDbNodes('market_has_exchange', market, exchanges[pair.exchange])
                
                connectDbNodes('market_has_baseCurrency', market, currencies[pair.baseCurrency])
                connectDbNodes('market_has_quoteCurrency', market, currencies[pair.quoteCurrency])
            }
            
        })
    })
}

       function connectDb(){
    const db = new Database('http://0.0.0.0:8529');
    db.useBasicAuth("root", "arangodb");
    createDatabase(db, "cryptoBot")
    db.useDatabase('cryptoBot'); 
    return db
}







// clearDatabase()
// process.exit()



