"main";let fs;_8e1‍.w("fs",[["default",["fs"],function(v){fs=v}]]);let connectDb,clearDatabase,createDbNode,connectDbNodes,getExchangeMarkets,setMarketPrice;_8e1‍.w("./database.js",[["connectDb",["connectDb"],function(v){connectDb=v}],["clearDatabase",["clearDatabase"],function(v){clearDatabase=v}],["createDbNode",["createDbNode"],function(v){createDbNode=v}],["connectDbNodes",["connectDbNodes"],function(v){connectDbNodes=v}],["getExchangeMarkets",["getExchangeMarkets"],function(v){getExchangeMarkets=v}],["setMarketPrice",["setMarketPrice"],function(v){setMarketPrice=v}]]);



async function updateDb(){
    const db = connectDb()
    
    // exchanges dir is read to load js files
    let exchangeModules = {}
    const exchangeModuleFiles = fs.readdirSync('exchanges')
    for (let exchangeModuleFile of exchangeModuleFiles){
        const exchangeName = exchangeModuleFile.split('.')[0]
        exchangeModules[exchangeName] = require(`./exchanges/${exchangeModuleFile}`)[exchangeName]
    }

    
    for (let exchangeName of Object.keys(exchangeModules)){
        const markets = await getExchangeMarkets(db, exchangeName)
        // console.log(markets)
        for (let market of markets){
            market = await exchangeModules[exchangeName].fetchMarketPrice(market)
            _8e1‍.g.console.log(market)
            return
            // setMarketPrice(db, market)
        }
        
    }
    
    return
    
    
    
        
    // build objects to store nodes and edges
    let marketNodes = {}
    let currencyNodes = {}
    let exchangeNodes = {}
    let tempEdges = TempEdges()
    
    // build exchanges nodes
    for (let exchangeModuleName of Object.keys(exchangeModules)){
        const exchangeNodeData = {
                                    label: exchangeModuleName,
                                    tradingFees: exchangeModules[exchangeModuleName].tradingFees
                                }
        exchangeNodes[exchangeModuleName] = await createDbNode(db, 'exchanges', exchangeNodeData)
    }
    
    // loop throught exchanges and markets to fill marketNodes and currencyNodes, also add edges to tempEdges object
    for (let exchangeModuleName of Object.keys(exchangeModules)){
        const markets = await exchangeModules[exchangeModuleName].fetchMarkets()
        for (let market of markets){
            
            const marketLabel = `${market.exchange} - ${market.baseCurrency}/${market.quoteCurrency}`
            
            if (!Object.keys(marketNodes).includes(marketLabel)){
                marketNodes[marketLabel] = await createDbNode(db, 'markets', {label: marketLabel})
            }
            
            if (!Object.keys(currencyNodes).includes(market.baseCurrency)){
                currencyNodes[market.baseCurrency] = await createDbNode(db, 'currencies', {label: market.baseCurrency})
            }
            
            if (!Object.keys(currencyNodes).includes(market.quoteCurrency)){
                currencyNodes[market.quoteCurrency] = await createDbNode(db, 'currencies', {label: market.quoteCurrency})
            }
            
            // get node ids then generate links
            const marketNode = marketNodes[marketLabel]
            const exchangeNode = exchangeNodes[market.exchange]
            const baseCurrencyNode = currencyNodes[market.baseCurrency]
            const quoteCurrencyNode= currencyNodes[market.quoteCurrency]
            
            // console.log(marketNodes)
            // console.log(currencyNodes)
            // console.log(market.exchange)
            
            
            tempEdges.add('marketHasExchange', marketNode, exchangeNode)
            tempEdges.add('marketHasCurrency', marketNode, baseCurrencyNode, {type: 'base'})
            tempEdges.add('marketHasCurrency', marketNode, quoteCurrencyNode, {type: 'quote'})
            tempEdges.add('exchangeHasCurrency', 
                        exchangeNode, 
                        baseCurrencyNode, 
                        {
                            withdrawalFees: exchangeModules[market.exchange].withdrawalFees[market.baseCurrency]
                        })
            // tempEdges.add('exchangeHasCurrency', 
            //             exchangeNode, 
            //             quoteCurrencyNode, 
            //             {
            //                 withdrawalFees: exchangeModules[market.exchange].withdrawalFees[market.quoteCurrency]
                            
            //             })
                        
            // tempEdges.add('exchangeHasCurrency', exchangeNode, quoteCurrencyNode)
            
        }
        // tempEdgeTree.out()
       tempEdges.build(db)
        
    }
}



updateDb()