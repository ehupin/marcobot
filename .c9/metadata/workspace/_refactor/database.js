{"changed":true,"filter":false,"title":"database.js","tooltip":"/_refactor/database.js","ace":{"folds":[],"scrolltop":133.5,"scrollleft":0,"selection":{"start":{"row":40,"column":1},"end":{"row":40,"column":1},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"value":"// import {getNodetypes} from '../common/utils.js'\nimport { Database, aql } from \"arangojs\";\n// import {listPairs} from './pairs.js'\n// import {exchanges_fees} from './exchanges.js'\n\n\nexport function connectDb(){\n    const db = new Database('http://0.0.0.0:8529');\n    db.useBasicAuth(\"root\", \"arangodb\");\n    createDatabase(db, \"cryptoBot_refactor\")\n    db.useDatabase('cryptoBot_refactor'); \n    return db\n}\n\nasync function createDatabase(db, dbName){\n    // create zoa database\n    const databases = await db.listDatabases()\n    if (!databases.includes(dbName)){\n        db.createDatabase(dbName)\n    }\n}\n\nexport async function clearDatabase(db) {\n    for (let collection of await db.listCollections()) {\n        if (!collection.isSystem) {\n            await db.collection(collection.name).drop();\n        }\n    }\n}\n\nexport async function createDbNode (db, nodetypeName, nodeData) {\n    const cursor = await db.query(aql`\n        INSERT \n        ${nodeData}\n        INTO ${db.collection(nodetypeName)}\n        RETURN NEW\n    `);\n    let node = await cursor.next()\n    // node._nodetypeName = nodetypeName\n    return node\n}\n\nexport async function deleteDbNode (db, nodeId) {\n    const collection = nodeId.split('/')[0]\n    const cursor = await db.query(aql`\n        REMOVE DOCUMENT(${nodeId}) in ${db.edgeCollection(collection)}\n    `);\n}\n\n\nexport async function setMarketData(db, marketLabel, data){\n    const cursor = await db.query(aql`\n    FOR market IN markets FILTER market.label == ${marketLabel}\n    UPDATE market WITH ${data} IN  ${db.edgeCollection('markets')}\n    return market\n    `);\n}\n\nexport async function setCurrencyFees(db, exchangeName, currencyName, data){\n    const cursor = await db.query(aql`\n            FOR exchangeCurrencyEdge IN exchangeHasCurrency \n            FILTER document(exchangeCurrencyEdge._from).name == ${exchangeName} && document(exchangeCurrencyEdge._to).name == ${currencyName} \n            UPDATE exchangeCurrencyEdge WITH ${data} IN  ${db.edgeCollection('exchangeHasCurrency')}\n            \n        `);\n}\n\nexport async function getArbitrageOpportunities(db, exchangeName, currency){\n    const cursor = await db.query(aql`\n        let walletCurrency = ${currency}\n        let walletExchange = ${exchangeName}\n        \n        for srcExchange in exchanges filter srcExchange.name == walletExchange\n        for srcCurrency in outbound srcExchange._id exchangeHasCurrency filter srcCurrency.name == walletCurrency\n        for srcMarket, srcCurrencyEdge in inbound srcCurrency._id marketHasCurrency\n        for checkSrcExchange in outbound srcMarket._id marketHasExchange filter checkSrcExchange._id == srcExchange._id\n        \n        for tmpCurrency in outbound srcMarket._id marketHasCurrency filter tmpCurrency._id != srcCurrency._id\n        \n        for dstMarket in inbound tmpCurrency._id marketHasCurrency filter dstMarket._id != srcMarket._id\n        for dstCurrency, dstCurrencyEdge in outbound dstMarket._id marketHasCurrency filter dstCurrency._id == srcCurrency._id\n        for dstExchange in outbound dstMarket._id marketHasExchange\n        \n        \n        for checkSrcExchangeForTmpCurrency, e in inbound tmpCurrency._id exchangeHasCurrency filter checkSrcExchangeForTmpCurrency._id == srcExchange._id\n        \n        let withdrawalFees = e.withdrawalFees\n        let srcTradingFees = srcExchange.tradingFees\n        let dstTradingFees = dstExchange.tradingFees\n        let srcPriceType = srcCurrencyEdge.type == 'quote' ? 'bid' : 'ask'\n        let dstPriceType = dstCurrencyEdge.type == 'quote' ? 'ask' : 'bid'\n        let srcPrice = srcPriceType == 'ask' ? srcMarket.askPrice : srcMarket.bidPrice\n        let dstPrice = dstPriceType == 'ask' ? dstMarket.askPrice : dstMarket.bidPrice\n        \n        //filter srcPrice<dstPrice\n        let srcPriceAdapted = srcPriceType == 'ask' ? srcPrice : 1/srcPrice\n        let dstPriceAdapted = dstPriceType == 'ask' ? dstPrice : 1/dstPrice\n        let ratio = ( srcPriceAdapted * ( 1 - srcTradingFees ) - withdrawalFees ) * dstPriceAdapted * (1 - dstTradingFees)\n            \n        sort ratio desc\n        return distinct {\n                        srxExchange: srcExchange.name,\n                        srcMarket: srcMarket.label,\n                        srcPriceType,\n                        srcPrice,\n                        srcTradingFees,\n                        tmpCurrency: tmpCurrency.name,\n                        withdrawalFees,\n                        dstExchange: dstExchange.name,\n                        dstMarket: dstMarket.name,\n                        dstPriceType,\n                        dstPrice,\n                        dstTradingFees,\n                        ratio}\n    `);\n    return cursor.all()\n}\n","undoManager":{"mark":89,"position":100,"stack":[[{"start":{"row":80,"column":58},"end":{"row":80,"column":60},"action":"remove","lines":["co"],"id":57},{"start":{"row":80,"column":58},"end":{"row":80,"column":68},"action":"insert","lines":["collection"]}],[{"start":{"row":84,"column":0},"end":{"row":85,"column":0},"action":"insert","lines":["",""],"id":58},{"start":{"row":85,"column":0},"end":{"row":86,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":85,"column":0},"end":{"row":92,"column":1},"action":"insert","lines":["export async function setMarketPrice(db, market, prices){","    const nodeDetails = {label: market.label}","    const cursor = await db.query(aql`","    FOR market IN markets FILTER market.label == ${market.label}","    UPDATE market WITH ${prices} IN  ${db.edgeCollection('markets')}","    return market","    `);","}"],"id":59}],[{"start":{"row":85,"column":22},"end":{"row":85,"column":36},"action":"remove","lines":["setMarketPrice"],"id":60},{"start":{"row":85,"column":22},"end":{"row":85,"column":23},"action":"insert","lines":["s"]},{"start":{"row":85,"column":23},"end":{"row":85,"column":24},"action":"insert","lines":["e"]},{"start":{"row":85,"column":24},"end":{"row":85,"column":25},"action":"insert","lines":["t"]},{"start":{"row":85,"column":25},"end":{"row":85,"column":26},"action":"insert","lines":["N"]},{"start":{"row":85,"column":26},"end":{"row":85,"column":27},"action":"insert","lines":["o"]},{"start":{"row":85,"column":27},"end":{"row":85,"column":28},"action":"insert","lines":["d"]},{"start":{"row":85,"column":28},"end":{"row":85,"column":29},"action":"insert","lines":["e"]}],[{"start":{"row":85,"column":29},"end":{"row":85,"column":30},"action":"insert","lines":["D"],"id":61},{"start":{"row":85,"column":30},"end":{"row":85,"column":31},"action":"insert","lines":["a"]},{"start":{"row":85,"column":31},"end":{"row":85,"column":32},"action":"insert","lines":["t"]},{"start":{"row":85,"column":32},"end":{"row":85,"column":33},"action":"insert","lines":["a"]}],[{"start":{"row":85,"column":28},"end":{"row":85,"column":29},"action":"remove","lines":["e"],"id":62},{"start":{"row":85,"column":27},"end":{"row":85,"column":28},"action":"remove","lines":["d"]},{"start":{"row":85,"column":26},"end":{"row":85,"column":27},"action":"remove","lines":["o"]},{"start":{"row":85,"column":25},"end":{"row":85,"column":26},"action":"remove","lines":["N"]}],[{"start":{"row":85,"column":25},"end":{"row":85,"column":26},"action":"insert","lines":["M"],"id":63},{"start":{"row":85,"column":26},"end":{"row":85,"column":27},"action":"insert","lines":["a"]},{"start":{"row":85,"column":27},"end":{"row":85,"column":28},"action":"insert","lines":["r"]},{"start":{"row":85,"column":28},"end":{"row":85,"column":29},"action":"insert","lines":["k"]},{"start":{"row":85,"column":29},"end":{"row":85,"column":30},"action":"insert","lines":["e"]},{"start":{"row":85,"column":30},"end":{"row":85,"column":31},"action":"insert","lines":["t"]}],[{"start":{"row":85,"column":48},"end":{"row":85,"column":54},"action":"remove","lines":["prices"],"id":64},{"start":{"row":85,"column":48},"end":{"row":85,"column":49},"action":"insert","lines":["d"]},{"start":{"row":85,"column":49},"end":{"row":85,"column":50},"action":"insert","lines":["a"]},{"start":{"row":85,"column":50},"end":{"row":85,"column":51},"action":"insert","lines":["t"]},{"start":{"row":85,"column":51},"end":{"row":85,"column":52},"action":"insert","lines":["a"]}],[{"start":{"row":85,"column":46},"end":{"row":85,"column":47},"action":"insert","lines":["L"],"id":65},{"start":{"row":85,"column":47},"end":{"row":85,"column":48},"action":"insert","lines":["a"]},{"start":{"row":85,"column":48},"end":{"row":85,"column":49},"action":"insert","lines":["b"]},{"start":{"row":85,"column":49},"end":{"row":85,"column":50},"action":"insert","lines":["e"]},{"start":{"row":85,"column":50},"end":{"row":85,"column":51},"action":"insert","lines":["l"]}],[{"start":{"row":88,"column":58},"end":{"row":88,"column":59},"action":"remove","lines":["l"],"id":66},{"start":{"row":88,"column":57},"end":{"row":88,"column":58},"action":"remove","lines":["."]}],[{"start":{"row":88,"column":57},"end":{"row":88,"column":58},"action":"insert","lines":["L"],"id":67}],[{"start":{"row":88,"column":40},"end":{"row":88,"column":41},"action":"remove","lines":["l"],"id":68},{"start":{"row":88,"column":40},"end":{"row":88,"column":41},"action":"remove","lines":["a"]},{"start":{"row":88,"column":40},"end":{"row":88,"column":41},"action":"remove","lines":["b"]},{"start":{"row":88,"column":40},"end":{"row":88,"column":41},"action":"remove","lines":["e"]},{"start":{"row":88,"column":40},"end":{"row":88,"column":41},"action":"remove","lines":["l"]}],[{"start":{"row":88,"column":40},"end":{"row":88,"column":41},"action":"insert","lines":["l"],"id":69},{"start":{"row":88,"column":41},"end":{"row":88,"column":42},"action":"insert","lines":["a"]},{"start":{"row":88,"column":42},"end":{"row":88,"column":43},"action":"insert","lines":["b"]},{"start":{"row":88,"column":43},"end":{"row":88,"column":44},"action":"insert","lines":["e"]},{"start":{"row":88,"column":44},"end":{"row":88,"column":45},"action":"insert","lines":["l"]}],[{"start":{"row":89,"column":25},"end":{"row":89,"column":31},"action":"remove","lines":["prices"],"id":70},{"start":{"row":89,"column":25},"end":{"row":89,"column":26},"action":"insert","lines":["d"]},{"start":{"row":89,"column":26},"end":{"row":89,"column":27},"action":"insert","lines":["a"]},{"start":{"row":89,"column":27},"end":{"row":89,"column":28},"action":"insert","lines":["t"]},{"start":{"row":89,"column":28},"end":{"row":89,"column":29},"action":"insert","lines":["a"]}],[{"start":{"row":85,"column":59},"end":{"row":86,"column":45},"action":"remove","lines":["","    const nodeDetails = {label: market.label}"],"id":71}],[{"start":{"row":91,"column":1},"end":{"row":92,"column":0},"action":"insert","lines":["",""],"id":72},{"start":{"row":92,"column":0},"end":{"row":93,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":93,"column":0},"end":{"row":99,"column":1},"action":"insert","lines":["export async function setMarketData(db, marketLabel, data){","    const cursor = await db.query(aql`","    FOR market IN markets FILTER market.label == ${marketLabel}","    UPDATE market WITH ${data} IN  ${db.edgeCollection('markets')}","    return market","    `);","}"],"id":73}],[{"start":{"row":93,"column":22},"end":{"row":93,"column":35},"action":"remove","lines":["setMarketData"],"id":74},{"start":{"row":93,"column":22},"end":{"row":93,"column":23},"action":"insert","lines":["s"]},{"start":{"row":93,"column":23},"end":{"row":93,"column":24},"action":"insert","lines":["e"]},{"start":{"row":93,"column":24},"end":{"row":93,"column":25},"action":"insert","lines":["t"]},{"start":{"row":93,"column":25},"end":{"row":93,"column":26},"action":"insert","lines":["C"]},{"start":{"row":93,"column":26},"end":{"row":93,"column":27},"action":"insert","lines":["u"]},{"start":{"row":93,"column":27},"end":{"row":93,"column":28},"action":"insert","lines":["r"]},{"start":{"row":93,"column":28},"end":{"row":93,"column":29},"action":"insert","lines":["r"]},{"start":{"row":93,"column":29},"end":{"row":93,"column":30},"action":"insert","lines":["e"]},{"start":{"row":93,"column":30},"end":{"row":93,"column":31},"action":"insert","lines":["n"]},{"start":{"row":93,"column":31},"end":{"row":93,"column":32},"action":"insert","lines":["c"]},{"start":{"row":93,"column":32},"end":{"row":93,"column":33},"action":"insert","lines":["i"]},{"start":{"row":93,"column":33},"end":{"row":93,"column":34},"action":"insert","lines":["e"]},{"start":{"row":93,"column":34},"end":{"row":93,"column":35},"action":"insert","lines":["s"]}],[{"start":{"row":93,"column":34},"end":{"row":93,"column":35},"action":"remove","lines":["s"],"id":75},{"start":{"row":93,"column":33},"end":{"row":93,"column":34},"action":"remove","lines":["e"]},{"start":{"row":93,"column":32},"end":{"row":93,"column":33},"action":"remove","lines":["i"]}],[{"start":{"row":93,"column":32},"end":{"row":93,"column":33},"action":"insert","lines":["y"],"id":76},{"start":{"row":93,"column":33},"end":{"row":93,"column":34},"action":"insert","lines":["F"]},{"start":{"row":93,"column":34},"end":{"row":93,"column":35},"action":"insert","lines":["e"]},{"start":{"row":93,"column":35},"end":{"row":93,"column":36},"action":"insert","lines":["e"]},{"start":{"row":93,"column":36},"end":{"row":93,"column":37},"action":"insert","lines":["s"]}],[{"start":{"row":93,"column":25},"end":{"row":93,"column":26},"action":"insert","lines":["M"],"id":77},{"start":{"row":93,"column":26},"end":{"row":93,"column":27},"action":"insert","lines":["a"]},{"start":{"row":93,"column":27},"end":{"row":93,"column":28},"action":"insert","lines":["r"]},{"start":{"row":93,"column":28},"end":{"row":93,"column":29},"action":"insert","lines":["k"]},{"start":{"row":93,"column":29},"end":{"row":93,"column":30},"action":"insert","lines":["e"]},{"start":{"row":93,"column":30},"end":{"row":93,"column":31},"action":"insert","lines":["t"]}],[{"start":{"row":93,"column":30},"end":{"row":93,"column":31},"action":"remove","lines":["t"],"id":78},{"start":{"row":93,"column":29},"end":{"row":93,"column":30},"action":"remove","lines":["e"]},{"start":{"row":93,"column":28},"end":{"row":93,"column":29},"action":"remove","lines":["k"]},{"start":{"row":93,"column":27},"end":{"row":93,"column":28},"action":"remove","lines":["r"]},{"start":{"row":93,"column":26},"end":{"row":93,"column":27},"action":"remove","lines":["a"]},{"start":{"row":93,"column":25},"end":{"row":93,"column":26},"action":"remove","lines":["M"]}],[{"start":{"row":93,"column":42},"end":{"row":93,"column":53},"action":"remove","lines":["marketLabel"],"id":79},{"start":{"row":93,"column":42},"end":{"row":93,"column":43},"action":"insert","lines":["e"]},{"start":{"row":93,"column":43},"end":{"row":93,"column":44},"action":"insert","lines":["x"]},{"start":{"row":93,"column":44},"end":{"row":93,"column":45},"action":"insert","lines":["c"]},{"start":{"row":93,"column":45},"end":{"row":93,"column":46},"action":"insert","lines":["h"]},{"start":{"row":93,"column":46},"end":{"row":93,"column":47},"action":"insert","lines":["a"]},{"start":{"row":93,"column":47},"end":{"row":93,"column":48},"action":"insert","lines":["n"]},{"start":{"row":93,"column":48},"end":{"row":93,"column":49},"action":"insert","lines":["g"]},{"start":{"row":93,"column":49},"end":{"row":93,"column":50},"action":"insert","lines":["e"]}],[{"start":{"row":93,"column":50},"end":{"row":93,"column":51},"action":"insert","lines":["N"],"id":80},{"start":{"row":93,"column":51},"end":{"row":93,"column":52},"action":"insert","lines":["a"]},{"start":{"row":93,"column":52},"end":{"row":93,"column":53},"action":"insert","lines":["m"]},{"start":{"row":93,"column":53},"end":{"row":93,"column":54},"action":"insert","lines":["e"]}],[{"start":{"row":94,"column":4},"end":{"row":98,"column":7},"action":"remove","lines":["const cursor = await db.query(aql`","    FOR market IN markets FILTER market.label == ${marketLabel}","    UPDATE market WITH ${data} IN  ${db.edgeCollection('markets')}","    return market","    `);"],"id":81},{"start":{"row":94,"column":4},"end":{"row":98,"column":11},"action":"insert","lines":["const cursor = await db.query(aql`","            FOR exchangeCurrencyEdge IN exchangeHasCurrency FILTER document(exchangeCurrencyEdge._from).label == ${exchangeName} && document(exchangeCurrencyEdge._to).label == ${coinLabel} ","            UPDATE exchangeCurrencyEdge WITH ${nodeData} IN  ${db.edgeCollection('exchangeHasCurrency')}","            ","        `);"]}],[{"start":{"row":95,"column":60},"end":{"row":96,"column":0},"action":"insert","lines":["",""],"id":82},{"start":{"row":96,"column":0},"end":{"row":96,"column":12},"action":"insert","lines":["            "]}],[{"start":{"row":93,"column":55},"end":{"row":93,"column":56},"action":"insert","lines":[" "],"id":83},{"start":{"row":93,"column":56},"end":{"row":93,"column":57},"action":"insert","lines":["c"]},{"start":{"row":93,"column":57},"end":{"row":93,"column":58},"action":"insert","lines":["o"]},{"start":{"row":93,"column":58},"end":{"row":93,"column":59},"action":"insert","lines":["i"]},{"start":{"row":93,"column":59},"end":{"row":93,"column":60},"action":"insert","lines":["n"]},{"start":{"row":93,"column":60},"end":{"row":93,"column":61},"action":"insert","lines":["L"]}],[{"start":{"row":93,"column":60},"end":{"row":93,"column":61},"action":"remove","lines":["L"],"id":84},{"start":{"row":93,"column":59},"end":{"row":93,"column":60},"action":"remove","lines":["n"]},{"start":{"row":93,"column":58},"end":{"row":93,"column":59},"action":"remove","lines":["i"]},{"start":{"row":93,"column":57},"end":{"row":93,"column":58},"action":"remove","lines":["o"]},{"start":{"row":93,"column":56},"end":{"row":93,"column":57},"action":"remove","lines":["c"]}],[{"start":{"row":93,"column":56},"end":{"row":93,"column":57},"action":"insert","lines":["c"],"id":85},{"start":{"row":93,"column":57},"end":{"row":93,"column":58},"action":"insert","lines":["u"]},{"start":{"row":93,"column":58},"end":{"row":93,"column":59},"action":"insert","lines":["r"]},{"start":{"row":93,"column":59},"end":{"row":93,"column":60},"action":"insert","lines":["r"]},{"start":{"row":93,"column":60},"end":{"row":93,"column":61},"action":"insert","lines":["e"]},{"start":{"row":93,"column":61},"end":{"row":93,"column":62},"action":"insert","lines":["n"]},{"start":{"row":93,"column":62},"end":{"row":93,"column":63},"action":"insert","lines":["c"]},{"start":{"row":93,"column":63},"end":{"row":93,"column":64},"action":"insert","lines":["y"]}],[{"start":{"row":93,"column":64},"end":{"row":93,"column":65},"action":"insert","lines":["N"],"id":86}],[{"start":{"row":93,"column":64},"end":{"row":93,"column":65},"action":"remove","lines":["N"],"id":87}],[{"start":{"row":93,"column":64},"end":{"row":93,"column":65},"action":"insert","lines":["N"],"id":88},{"start":{"row":93,"column":65},"end":{"row":93,"column":66},"action":"insert","lines":["a"]},{"start":{"row":93,"column":66},"end":{"row":93,"column":67},"action":"insert","lines":["m"]},{"start":{"row":93,"column":67},"end":{"row":93,"column":68},"action":"insert","lines":["e"]},{"start":{"row":93,"column":68},"end":{"row":93,"column":69},"action":"insert","lines":[","]}],[{"start":{"row":96,"column":130},"end":{"row":96,"column":139},"action":"remove","lines":["coinLabel"],"id":89},{"start":{"row":96,"column":130},"end":{"row":96,"column":142},"action":"insert","lines":["currencyName"]}],[{"start":{"row":96,"column":56},"end":{"row":96,"column":61},"action":"remove","lines":["label"],"id":90},{"start":{"row":96,"column":56},"end":{"row":96,"column":57},"action":"insert","lines":["n"]},{"start":{"row":96,"column":57},"end":{"row":96,"column":58},"action":"insert","lines":["a"]},{"start":{"row":96,"column":58},"end":{"row":96,"column":59},"action":"insert","lines":["m"]},{"start":{"row":96,"column":59},"end":{"row":96,"column":60},"action":"insert","lines":["e"]}],[{"start":{"row":96,"column":118},"end":{"row":96,"column":123},"action":"remove","lines":["label"],"id":91},{"start":{"row":96,"column":118},"end":{"row":96,"column":119},"action":"insert","lines":["n"]},{"start":{"row":96,"column":119},"end":{"row":96,"column":120},"action":"insert","lines":["a"]},{"start":{"row":96,"column":120},"end":{"row":96,"column":121},"action":"insert","lines":["m"]},{"start":{"row":96,"column":121},"end":{"row":96,"column":122},"action":"insert","lines":["e"]}],[{"start":{"row":97,"column":47},"end":{"row":97,"column":55},"action":"remove","lines":["nodeData"],"id":92},{"start":{"row":97,"column":47},"end":{"row":97,"column":48},"action":"insert","lines":["d"]},{"start":{"row":97,"column":48},"end":{"row":97,"column":49},"action":"insert","lines":["a"]},{"start":{"row":97,"column":49},"end":{"row":97,"column":50},"action":"insert","lines":["t"]},{"start":{"row":97,"column":50},"end":{"row":97,"column":51},"action":"insert","lines":["a"]}],[{"start":{"row":85,"column":59},"end":{"row":86,"column":0},"action":"insert","lines":["",""],"id":93},{"start":{"row":86,"column":0},"end":{"row":86,"column":4},"action":"insert","lines":["    "]},{"start":{"row":86,"column":4},"end":{"row":86,"column":5},"action":"insert","lines":["c"]},{"start":{"row":86,"column":5},"end":{"row":86,"column":6},"action":"insert","lines":["o"]},{"start":{"row":86,"column":6},"end":{"row":86,"column":7},"action":"insert","lines":["n"]},{"start":{"row":86,"column":7},"end":{"row":86,"column":8},"action":"insert","lines":["s"]},{"start":{"row":86,"column":8},"end":{"row":86,"column":9},"action":"insert","lines":["o"]},{"start":{"row":86,"column":9},"end":{"row":86,"column":10},"action":"insert","lines":["l"]},{"start":{"row":86,"column":10},"end":{"row":86,"column":11},"action":"insert","lines":["e"]}],[{"start":{"row":86,"column":11},"end":{"row":86,"column":12},"action":"insert","lines":["."],"id":94},{"start":{"row":86,"column":12},"end":{"row":86,"column":13},"action":"insert","lines":["l"]},{"start":{"row":86,"column":13},"end":{"row":86,"column":14},"action":"insert","lines":["o"]},{"start":{"row":86,"column":14},"end":{"row":86,"column":15},"action":"insert","lines":["g"]}],[{"start":{"row":86,"column":15},"end":{"row":86,"column":17},"action":"insert","lines":["()"],"id":95}],[{"start":{"row":86,"column":16},"end":{"row":86,"column":18},"action":"insert","lines":["``"],"id":96}],[{"start":{"row":86,"column":17},"end":{"row":86,"column":18},"action":"insert","lines":["U"],"id":97},{"start":{"row":86,"column":18},"end":{"row":86,"column":19},"action":"insert","lines":["p"]},{"start":{"row":86,"column":19},"end":{"row":86,"column":20},"action":"insert","lines":["d"]},{"start":{"row":86,"column":20},"end":{"row":86,"column":21},"action":"insert","lines":["a"]},{"start":{"row":86,"column":21},"end":{"row":86,"column":22},"action":"insert","lines":["t"]},{"start":{"row":86,"column":22},"end":{"row":86,"column":23},"action":"insert","lines":["e"]}],[{"start":{"row":86,"column":23},"end":{"row":86,"column":24},"action":"insert","lines":[" "],"id":98},{"start":{"row":86,"column":24},"end":{"row":86,"column":25},"action":"insert","lines":["$"]},{"start":{"row":86,"column":25},"end":{"row":86,"column":26},"action":"insert","lines":["{"]},{"start":{"row":86,"column":26},"end":{"row":86,"column":27},"action":"insert","lines":["}"]}],[{"start":{"row":86,"column":26},"end":{"row":86,"column":27},"action":"insert","lines":["m"],"id":99},{"start":{"row":86,"column":27},"end":{"row":86,"column":28},"action":"insert","lines":["a"]}],[{"start":{"row":86,"column":26},"end":{"row":86,"column":28},"action":"remove","lines":["ma"],"id":100},{"start":{"row":86,"column":26},"end":{"row":86,"column":37},"action":"insert","lines":["marketLabel"]}],[{"start":{"row":86,"column":39},"end":{"row":86,"column":40},"action":"insert","lines":[" "],"id":101},{"start":{"row":86,"column":40},"end":{"row":86,"column":41},"action":"insert","lines":["w"]},{"start":{"row":86,"column":41},"end":{"row":86,"column":42},"action":"insert","lines":["i"]},{"start":{"row":86,"column":42},"end":{"row":86,"column":43},"action":"insert","lines":["t"]},{"start":{"row":86,"column":43},"end":{"row":86,"column":44},"action":"insert","lines":["h"]}],[{"start":{"row":86,"column":44},"end":{"row":86,"column":45},"action":"insert","lines":[" "],"id":102}],[{"start":{"row":86,"column":44},"end":{"row":86,"column":45},"action":"remove","lines":[" "],"id":103},{"start":{"row":86,"column":43},"end":{"row":86,"column":44},"action":"remove","lines":["h"]},{"start":{"row":86,"column":42},"end":{"row":86,"column":43},"action":"remove","lines":["t"]},{"start":{"row":86,"column":41},"end":{"row":86,"column":42},"action":"remove","lines":["i"]},{"start":{"row":86,"column":40},"end":{"row":86,"column":41},"action":"remove","lines":["w"]},{"start":{"row":86,"column":39},"end":{"row":86,"column":40},"action":"remove","lines":[" "]},{"start":{"row":86,"column":38},"end":{"row":86,"column":39},"action":"remove","lines":["`"]}],[{"start":{"row":86,"column":38},"end":{"row":86,"column":39},"action":"insert","lines":[" "],"id":104}],[{"start":{"row":86,"column":39},"end":{"row":86,"column":40},"action":"insert","lines":["`"],"id":105},{"start":{"row":86,"column":40},"end":{"row":86,"column":41},"action":"insert","lines":["`"]}],[{"start":{"row":86,"column":41},"end":{"row":87,"column":0},"action":"insert","lines":["",""],"id":106},{"start":{"row":87,"column":0},"end":{"row":87,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":86,"column":41},"end":{"row":87,"column":0},"action":"remove","lines":["",""],"id":107},{"start":{"row":86,"column":40},"end":{"row":86,"column":41},"action":"remove","lines":["`"]}],[{"start":{"row":86,"column":39},"end":{"row":86,"column":40},"action":"insert","lines":["w"],"id":108},{"start":{"row":86,"column":40},"end":{"row":86,"column":41},"action":"insert","lines":["i"]},{"start":{"row":86,"column":41},"end":{"row":86,"column":42},"action":"insert","lines":["t"]},{"start":{"row":86,"column":42},"end":{"row":86,"column":43},"action":"insert","lines":["h"]}],[{"start":{"row":86,"column":43},"end":{"row":86,"column":44},"action":"insert","lines":[" "],"id":109},{"start":{"row":86,"column":44},"end":{"row":86,"column":45},"action":"insert","lines":["$"]},{"start":{"row":86,"column":45},"end":{"row":86,"column":46},"action":"insert","lines":["P"]}],[{"start":{"row":86,"column":45},"end":{"row":86,"column":46},"action":"remove","lines":["P"],"id":110}],[{"start":{"row":86,"column":45},"end":{"row":86,"column":46},"action":"insert","lines":["{"],"id":111},{"start":{"row":86,"column":46},"end":{"row":86,"column":47},"action":"insert","lines":["}"]}],[{"start":{"row":86,"column":46},"end":{"row":86,"column":47},"action":"insert","lines":["d"],"id":112},{"start":{"row":86,"column":47},"end":{"row":86,"column":48},"action":"insert","lines":["a"]},{"start":{"row":86,"column":48},"end":{"row":86,"column":49},"action":"insert","lines":["t"]},{"start":{"row":86,"column":49},"end":{"row":86,"column":50},"action":"insert","lines":["a"]}],[{"start":{"row":86,"column":52},"end":{"row":86,"column":56},"action":"remove","lines":["    "],"id":113},{"start":{"row":86,"column":52},"end":{"row":86,"column":53},"action":"remove","lines":[")"]}],[{"start":{"row":86,"column":52},"end":{"row":86,"column":53},"action":"insert","lines":["}"],"id":114}],[{"start":{"row":86,"column":52},"end":{"row":86,"column":53},"action":"remove","lines":["}"],"id":115}],[{"start":{"row":86,"column":52},"end":{"row":86,"column":53},"action":"insert","lines":[")"],"id":116}],[{"start":{"row":94,"column":76},"end":{"row":95,"column":0},"action":"insert","lines":["",""],"id":117},{"start":{"row":95,"column":0},"end":{"row":95,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":95,"column":4},"end":{"row":95,"column":53},"action":"insert","lines":["console.log(`Update ${marketLabel} with ${data}`)"],"id":118}],[{"start":{"row":95,"column":24},"end":{"row":95,"column":25},"action":"insert","lines":["f"],"id":119},{"start":{"row":95,"column":25},"end":{"row":95,"column":26},"action":"insert","lines":["e"]},{"start":{"row":95,"column":26},"end":{"row":95,"column":27},"action":"insert","lines":["e"]},{"start":{"row":95,"column":27},"end":{"row":95,"column":28},"action":"insert","lines":["s"]}],[{"start":{"row":95,"column":28},"end":{"row":95,"column":29},"action":"insert","lines":[" "],"id":120},{"start":{"row":95,"column":29},"end":{"row":95,"column":30},"action":"insert","lines":["f"]},{"start":{"row":95,"column":30},"end":{"row":95,"column":31},"action":"insert","lines":["o"]},{"start":{"row":95,"column":31},"end":{"row":95,"column":32},"action":"insert","lines":["r"]}],[{"start":{"row":95,"column":32},"end":{"row":95,"column":33},"action":"insert","lines":[" "],"id":121}],[{"start":{"row":86,"column":23},"end":{"row":86,"column":24},"action":"insert","lines":[" "],"id":122},{"start":{"row":86,"column":24},"end":{"row":86,"column":25},"action":"insert","lines":["m"]},{"start":{"row":86,"column":25},"end":{"row":86,"column":26},"action":"insert","lines":["a"]},{"start":{"row":86,"column":26},"end":{"row":86,"column":27},"action":"insert","lines":["r"]},{"start":{"row":86,"column":27},"end":{"row":86,"column":28},"action":"insert","lines":["k"]},{"start":{"row":86,"column":28},"end":{"row":86,"column":29},"action":"insert","lines":["e"]},{"start":{"row":86,"column":29},"end":{"row":86,"column":30},"action":"insert","lines":["t"]}],[{"start":{"row":95,"column":35},"end":{"row":95,"column":46},"action":"remove","lines":["marketLabel"],"id":123},{"start":{"row":95,"column":35},"end":{"row":95,"column":36},"action":"insert","lines":["e"]}],[{"start":{"row":95,"column":35},"end":{"row":95,"column":36},"action":"remove","lines":["e"],"id":124},{"start":{"row":95,"column":35},"end":{"row":95,"column":47},"action":"insert","lines":["exchangeName"]}],[{"start":{"row":95,"column":47},"end":{"row":95,"column":48},"action":"insert","lines":["+"],"id":125}],[{"start":{"row":95,"column":48},"end":{"row":95,"column":50},"action":"insert","lines":["''"],"id":126}],[{"start":{"row":95,"column":49},"end":{"row":95,"column":50},"action":"remove","lines":["'"],"id":127},{"start":{"row":95,"column":48},"end":{"row":95,"column":49},"action":"remove","lines":["'"]},{"start":{"row":95,"column":47},"end":{"row":95,"column":48},"action":"remove","lines":["+"]}],[{"start":{"row":95,"column":47},"end":{"row":95,"column":48},"action":"insert","lines":["+"],"id":128}],[{"start":{"row":95,"column":48},"end":{"row":95,"column":50},"action":"insert","lines":["''"],"id":129}],[{"start":{"row":95,"column":50},"end":{"row":95,"column":51},"action":"insert","lines":["+"],"id":130},{"start":{"row":95,"column":51},"end":{"row":95,"column":52},"action":"insert","lines":["c"]},{"start":{"row":95,"column":52},"end":{"row":95,"column":53},"action":"insert","lines":["u"]}],[{"start":{"row":95,"column":51},"end":{"row":95,"column":53},"action":"remove","lines":["cu"],"id":131},{"start":{"row":95,"column":51},"end":{"row":95,"column":61},"action":"insert","lines":["currencies"]}],[{"start":{"row":95,"column":60},"end":{"row":95,"column":61},"action":"remove","lines":["s"],"id":132},{"start":{"row":95,"column":59},"end":{"row":95,"column":60},"action":"remove","lines":["e"]},{"start":{"row":95,"column":58},"end":{"row":95,"column":59},"action":"remove","lines":["i"]}],[{"start":{"row":95,"column":58},"end":{"row":95,"column":59},"action":"insert","lines":["y"],"id":133}],[{"start":{"row":95,"column":51},"end":{"row":95,"column":59},"action":"remove","lines":["currency"],"id":134},{"start":{"row":95,"column":51},"end":{"row":95,"column":63},"action":"insert","lines":["currencyName"]}],[{"start":{"row":95,"column":49},"end":{"row":95,"column":50},"action":"insert","lines":["-"],"id":135}],[{"start":{"row":95,"column":4},"end":{"row":95,"column":7},"action":"insert","lines":["// "],"id":136}],[{"start":{"row":86,"column":4},"end":{"row":86,"column":7},"action":"insert","lines":["// "],"id":137}],[{"start":{"row":94,"column":76},"end":{"row":95,"column":83},"action":"remove","lines":["","    // console.log(`Update fees for ${exchangeName+'-'+currencyName} with ${data}`)"],"id":138}],[{"start":{"row":85,"column":59},"end":{"row":86,"column":63},"action":"remove","lines":["","    // console.log(`Update market ${marketLabel} with ${data}`)"],"id":139}],[{"start":{"row":101,"column":0},"end":{"row":121,"column":0},"action":"remove","lines":["","export async function setMarketPrice(db, market, prices){","    const nodeDetails = {label: market.label}","    const cursor = await db.query(aql`","    FOR market IN markets FILTER market.label == ${market.label}","    UPDATE market WITH ${prices} IN  ${db.edgeCollection('markets')}","    return market","    `);","}","","export async function setWithdrawalFees(db, exchangeName, withdrawalFees){","    for (const coinLabel in withdrawalFees){","        const nodeData = {withdrawalFees: Number(withdrawalFees[coinLabel])}","        const cursor = await db.query(aql`","            FOR exchangeCurrencyEdge IN exchangeHasCurrency FILTER document(exchangeCurrencyEdge._from).label == ${exchangeName} && document(exchangeCurrencyEdge._to).label == ${coinLabel} ","            UPDATE exchangeCurrencyEdge WITH ${nodeData} IN  ${db.edgeCollection('exchangeHasCurrency')}","            ","        `);","    }","}",""],"id":140}],[{"start":{"row":107,"column":56},"end":{"row":107,"column":61},"action":"remove","lines":["label"],"id":141},{"start":{"row":107,"column":56},"end":{"row":107,"column":57},"action":"insert","lines":["n"]},{"start":{"row":107,"column":57},"end":{"row":107,"column":58},"action":"insert","lines":["a"]},{"start":{"row":107,"column":58},"end":{"row":107,"column":59},"action":"insert","lines":["m"]},{"start":{"row":107,"column":59},"end":{"row":107,"column":60},"action":"insert","lines":["e"]}],[{"start":{"row":108,"column":91},"end":{"row":108,"column":96},"action":"remove","lines":["label"],"id":142},{"start":{"row":108,"column":91},"end":{"row":108,"column":92},"action":"insert","lines":["n"]},{"start":{"row":108,"column":92},"end":{"row":108,"column":93},"action":"insert","lines":["a"]},{"start":{"row":108,"column":93},"end":{"row":108,"column":94},"action":"insert","lines":["m"]},{"start":{"row":108,"column":94},"end":{"row":108,"column":95},"action":"insert","lines":["e"]}],[{"start":{"row":136,"column":49},"end":{"row":136,"column":54},"action":"remove","lines":["label"],"id":143},{"start":{"row":136,"column":49},"end":{"row":136,"column":50},"action":"insert","lines":["n"]},{"start":{"row":136,"column":50},"end":{"row":136,"column":51},"action":"insert","lines":["a"]},{"start":{"row":136,"column":51},"end":{"row":136,"column":52},"action":"insert","lines":["m"]},{"start":{"row":136,"column":52},"end":{"row":136,"column":53},"action":"insert","lines":["e"]}],[{"start":{"row":141,"column":49},"end":{"row":141,"column":54},"action":"remove","lines":["label"],"id":144},{"start":{"row":141,"column":49},"end":{"row":141,"column":50},"action":"insert","lines":["n"]},{"start":{"row":141,"column":50},"end":{"row":141,"column":51},"action":"insert","lines":["a"]},{"start":{"row":141,"column":51},"end":{"row":141,"column":52},"action":"insert","lines":["m"]},{"start":{"row":141,"column":52},"end":{"row":141,"column":53},"action":"insert","lines":["e"]}],[{"start":{"row":144,"column":45},"end":{"row":144,"column":50},"action":"remove","lines":["label"],"id":145},{"start":{"row":144,"column":45},"end":{"row":144,"column":46},"action":"insert","lines":["n"]},{"start":{"row":144,"column":46},"end":{"row":144,"column":47},"action":"insert","lines":["a"]},{"start":{"row":144,"column":47},"end":{"row":144,"column":48},"action":"insert","lines":["m"]},{"start":{"row":144,"column":48},"end":{"row":144,"column":49},"action":"insert","lines":["e"]}],[{"start":{"row":143,"column":49},"end":{"row":143,"column":54},"action":"remove","lines":["label"],"id":146},{"start":{"row":143,"column":49},"end":{"row":143,"column":50},"action":"insert","lines":["n"]},{"start":{"row":143,"column":50},"end":{"row":143,"column":51},"action":"insert","lines":["a"]},{"start":{"row":143,"column":51},"end":{"row":143,"column":52},"action":"insert","lines":["m"]},{"start":{"row":143,"column":52},"end":{"row":143,"column":53},"action":"insert","lines":["e"]}],[{"start":{"row":151,"column":1},"end":{"row":194,"column":0},"action":"remove","lines":["","","export async function getExchangeMarkets(db, exchangeName){","    const cursor = await db.query(aql`","    for exchange in exchanges filter exchange.label == ${exchangeName}","    for market in inbound exchange._id marketHasExchange","    return distinct market","    `);","    return cursor.all()","}","","function buildDb(){","    initDb().then(()=>{","        listPairs().then(async (pairs) => {","            let exchanges = {}","            let currencies = {}","            let markets = []","            for(let pair of pairs){","                console.log('\\n====================\\n')","                if (!Object.keys(exchanges).includes(pair.exchange)){","                    exchanges[pair.exchange] = await createDbNode('exchange', {label: pair.exchange})","                }","                ","                if (!Object.keys(currencies).includes(pair.baseCurrency)){","                    currencies[pair.baseCurrency] = await createDbNode('currency', {label: pair.baseCurrency})","                }","                ","                if (!Object.keys(currencies).includes(pair.quoteCurrency)){","                    currencies[pair.quoteCurrency] = await createDbNode('currency', {label: pair.quoteCurrency})","                }","                ","","                const market = await createDbNode('market', {label: `${pair.baseCurrency}/${pair.quoteCurrency} - ${pair.exchange}`})","             ","                connectDbNodes('market_has_exchange', market, exchanges[pair.exchange])","                ","                connectDbNodes('market_has_baseCurrency', market, currencies[pair.baseCurrency])","                connectDbNodes('market_has_quoteCurrency', market, currencies[pair.quoteCurrency])","            }","            ","        })","    })","}",""],"id":147}],[{"start":{"row":151,"column":1},"end":{"row":152,"column":0},"action":"remove","lines":["",""],"id":148},{"start":{"row":151,"column":1},"end":{"row":152,"column":0},"action":"remove","lines":["",""]},{"start":{"row":151,"column":1},"end":{"row":152,"column":0},"action":"remove","lines":["",""]},{"start":{"row":151,"column":1},"end":{"row":152,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":22,"column":0},"end":{"row":62,"column":1},"action":"remove","lines":["","async function initDb(){","    const collections = await db.listCollections()","    const collectionsName = collections.map(collection => collection.name);","    ","    for (let collectionName of ['exchange', 'currency', 'market']){","        if (!collectionsName.includes(collectionName)){","            let collection = db.collection(collectionName);","            // console.log(collection)","            collection.create()","        }","    }","    ","    for (let collectionName of ['market_has_exchange','market_has_baseCurrency', 'market_has_quoteCurrency', 'exchange_has_currency']){","        if (!collectionsName.includes(collectionName)){","            let collection = db.edgeCollection(collectionName);","            // console.log(collection)","            collection.create()","        }","    }","    ","    ","    ","    // db.edgeCollection(collectionName, true)","    ","}","    ","async function updateCollections(){","    const collections = await db.listCollections()","    const collectionsName = collections.map(collection => collection.name);","    ","    // for each nodetype, create a collection if it doesn't exist","    getNodetypes().forEach(async function (nodetype) {","        ","        if (!collectionsName.includes(nodetype.name)){","            let collection = db.collection(nodetype.name);","            // TODO: prevent creation of collectionns starting with \"_\", check it seems to be prevented by default","            await collection.create()","        }","    })","}"],"id":149},{"start":{"row":22,"column":0},"end":{"row":23,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":111,"column":0},"end":{"row":119,"column":0},"action":"remove","lines":["","export function connectDb(){","    const db = new Database('http://0.0.0.0:8529');","    db.useBasicAuth(\"root\", \"arangodb\");","    createDatabase(db, \"cryptoBot_refactor\")","    db.useDatabase('cryptoBot_refactor'); ","    return db","}",""],"id":150}],[{"start":{"row":111,"column":0},"end":{"row":123,"column":0},"action":"remove","lines":["","","","","","","","// clearDatabase()","// process.exit()","","","",""],"id":151}],[{"start":{"row":4,"column":0},"end":{"row":5,"column":0},"action":"insert","lines":["",""],"id":152}],[{"start":{"row":5,"column":0},"end":{"row":13,"column":0},"action":"insert","lines":["","export function connectDb(){","    const db = new Database('http://0.0.0.0:8529');","    db.useBasicAuth(\"root\", \"arangodb\");","    createDatabase(db, \"cryptoBot_refactor\")","    db.useDatabase('cryptoBot_refactor'); ","    return db","}",""],"id":153}],[{"start":{"row":24,"column":0},"end":{"row":30,"column":1},"action":"remove","lines":["async function createDatabase(db, dbName){","    // create zoa database","    const databases = await db.listDatabases()","    if (!databases.includes(dbName)){","        db.createDatabase(dbName)","    }","}"],"id":154}],[{"start":{"row":14,"column":0},"end":{"row":20,"column":1},"action":"insert","lines":["async function createDatabase(db, dbName){","    // create zoa database","    const databases = await db.listDatabases()","    if (!databases.includes(dbName)){","        db.createDatabase(dbName)","    }","}"],"id":155}],[{"start":{"row":29,"column":0},"end":{"row":30,"column":0},"action":"remove","lines":["",""],"id":156},{"start":{"row":29,"column":0},"end":{"row":30,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":40,"column":1},"end":{"row":41,"column":0},"action":"remove","lines":["",""],"id":157}]]},"timestamp":1539196655212}